name: Trigger + Verify Regression (Different Repo)

on:
  workflow_dispatch:

jobs:
  trigger_and_verify:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger regression workflow in Repo B
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
          OWNER: neharikamuppala96-commits
          REPO: Testing
          WORKFLOW_FILE: regression.yml   # Repo B workflow numeric ID
          REF: main
          ENV_NAME: qa
        run: |
          set -euo pipefail

          echo "Triggering ${OWNER}/${REPO} workflow_id=${WORKFLOW_FILE} ref=${REF} env=${ENV_NAME}"

          HTTP_CODE=$(curl -sS -L \
            -o response.json \
            -w "%{http_code}" \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/dispatches \
            -d '{"ref":"'"${REF}"'","inputs":{"env":"'"${ENV_NAME}"'"}}')

          echo "HTTP_CODE=$HTTP_CODE"
          cat response.json || true

          if [ "$HTTP_CODE" -ne 204 ]; then
            echo "❌ Dispatch was NOT accepted"
            exit 1
          fi

          echo "✅ Dispatch accepted (204)"

      - name: Verify a run was created (jq)
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
          OWNER: neharikamuppala96-commits
          REPO: Testing
          WORKFLOW_FILE: regression.yml
        run: |
          set -euo pipefail

          echo "Fetching latest workflow runs for workflow_file=${WORKFLOW_FILE} ..."

          curl -sS -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/runs?per_page=1" \
            | jq -r '
                .workflow_runs[0] |
                "latest_run_id=\(.id)\nstatus=\(.status)\nconclusion=\(.conclusion)\nhtml_url=\(.html_url)\ncreated_at=\(.created_at)\nevent=\(.event)"
              '
